<!DOCTYPE html>
<html xmlnx:th="http://www.thymeleaf.org">
<head th:include="common/include :: header"></head>
<script th:src="@{/assets/layui/layui_exts/excel.js}"></script>
<body>
    签约统计表
<div >
    <div class="layui-form">
        <button class="layui-btn layui-btn-sm layui-btn-normal refreshBtn"><i class="layui-icon layui-icon-refresh-3"></i>刷新</button>
        <button id="openAddLayer"  class="layui-btn layui-btn-sm layui-btn-normal openAddLayer"><i class="layui-icon layui-icon-add-1"></i>添加</button>
        <button id="exportXls" class="layui-btn layui-btn-sm layui-btn-normal "  ><i class="layui-icon layui-icon-export"></i>导出</button>
    </div>
    <div id="tableList" style="" >
        <table id="tableData" lay-filter="tableData" class="layui-tab" >

        </table>
    </div>
</div>
<script type="text/html" id="toolbar">
    <a class="layui-btn layui-btn-normal layui-btn-xs" lay-event="edit">修改</a>
    <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="delete">删除</a>
</script>

<script th:inline="javascript">
   layui.use(['table','layer','form','excel'],function(){
        var table = layui.table;
        var layer = layui.layer;
        var $ = layui.jquery;
        var excel = layui.excel;

        $("#openAddLayer").on('click',function () {
            layer.open({
                type:2,
                title:'添加签约记录',
                content:ctx+'sys/signing/addInit',
                area:['1000px','600px'],
                maxmin:true,
                fixed: false  //不固定

            });
        });
        var tableObj = table.render({
            elem:'#tableData',
            url:ctx+"sys/signing/SigningList",
            skin: 'row', //列边框风格
            even: true ,//开启隔行背景
            title:'签约统计表',
            page:{theme:'#1E9FFF'},
            limit:50,
            limits:[20,50,100,500],
            height:'full-70',
            parseData:function(res){
                console.log(res);
            },
            cols: [ [
                {checkbox: true, fixed: true},
                {title:'操作',fixed: 'left', width:150, align:'center', toolbar: '#toolbar'},
                {field:'id',title:'ID' ,align:'center',width:100},
                {field:'city',title:'城市', align:'center',width:110},
                {field:'mechanism',title:'机构名称', align:'center',width:350},
                {field:'department',title:'部门', align:'center',width:200},
                {field:'part_depart',title:'分点名称', align:'center',width:180},
                {field:'date_year',title:'年度', align:'center',width:90},
                {field:'date_month',title:'月份', align:'center',width:60},
                {field:'date_day',title:'日期', align:'center',width:110},
                {field:'linesTitle',title:'条线', align:'center',width:90},
                {field:'country_title',title:'国家', align:'center',width:90},
                {field:'customer_k3_code',title:'客户K3码', align:'center',width:220},
                {field:'customer_name',title:'客户名字', align:'center',width:150},
                {field:'contract_num',title:'合同号', align:'center',width:200},
                {field:'contract_mould',title:'合同模板', align:'center',width:500},
                {field:'oa_serial_number',title:'OA流水号', align:'center',width:180},
                {field:'customer_grade',title:'客户年级', align:'center',width:140},
                {field:'business_type',title:'业务类型', align:'center',width:130},
                {field:'product_type',title:'产品类型', align:'center',width:150},
                {field:'target_degree',title:'目标学位', align:'center',width:120},
                {field:'signing_adviser',title:'签约顾问', align:'center',width:140},
                {field:'apply_year',title:'入学申请年', align:'center',width:140},
                {field:'apply_month',title:'入学申请月', align:'center',width:140},
                {field:'signing_money',title:'签约金额', align:'center',width:140},
                {field:'main_contract_money',title:'主合同金额', align:'center',width:140},
                {field:'service_money',title:'服务费收款金额', align:'center',width:140},
                {field:'discount_type',title:'优惠类型', align:'center',width:150},
                {field:'discount_reason',title:'优惠原因', align:'center',width:500},
                {field:'discount_money',title:'优惠金额', align:'center',width:150},
                {field:'contract_state_title',title:'合同状态', align:'center',width:120},
                {field:'product_category_title',title:'产品分类', align:'center',width:90},
                {field:'overseas_study_apply_title',title:'留学申请', align:'center',width:90},
                {field:'language_train_title',title:'语言培训', align:'center',width:90},
                {field:'signing_class_name',title:'签约班级名称', align:'center',width:100},
                {field:'signing_class_code',title:'签约班级编码', align:'center',width:120},
                {field:'signing_curriculum_type',title:'签约课程类型', align:'center',width:120},
                {field:'remarks_one',title:'备注一', align:'center',width:500},
                {field:'remarks_two',title:'备注二', align:'center',width:500},
                {field:'overseas_or_train_title',title:'留学/培训', align:'center',width:100},
                {field:'week_num',title:'周数', align:'center',width:90},
                {field:'remarks_year',title:'财年', align:'center',width:90}


            ] ]
        });
        table.on('tool(tableData)',function (obj) {
            var data = obj.data; //获得当前行数据
            var layEvent = obj.event; //获得 lay-event 对应的值（也可以是表头的 event 参数对应的值）
            if(layEvent=='edit'){
                layer.open({
                    type:2,
                    title:'添加签约记录',
                    content:ctx+'sys/signing/addInit?id='+data.id,
                    area:['1000px','600px'],
                    maxmin:true,
                    fixed: false  //不固定

                });

            }else if(layEvent == 'delete'){
                layer.confirm('真的删除这行么', function(index){
                    obj.del(); //删除对应行（tr）的DOM结构，并更新缓存
                    layer.close(index);
                    //向服务端发送删除指令
                    $.ajax({
                        url:ctx+'sys/signing/delete',
                        type:"POST",
                        data:{id:data.id},
                        dataType:"json",
                        success:function(res){
                            layer.open({
                               title:'提示',
                               content:res.message
                            });
                        }
                    });
                });
            }

        });
        $("#exportXls").click(function () {

            $.ajax({
               url:ctx+"sys/signing/export",
                type:"POST",
                data:{},
                dataType:"json",
                success:function(res){
                    var data = res.data;
                    // 重点！！！如果后端给的数据顺序和映射关系不对，请执行梳理函数后导出
                    data = excel.filterExportData(data, [
                        'id'
                        ,'city'
                        ,'mechanism'
                        ,'department'
                        ,'part_depart'
                        ,'date_year'
                        ,'date_month'
                        ,'date_day'
                        ,'linesTitle'
                        ,'country_title'
                        ,'customer_k3_code'
                        ,'customer_name'
                        ,'contract_num'
                        ,'contract_mould'
                        ,'oa_serial_number'
                        ,'customer_grade'
                        ,'business_type'
                        ,'product_type'
                        ,'target_degree'
                        ,'signing_adviser'
                        ,'apply_year'
                        ,'apply_month'
                        ,'signing_money'
                        ,'main_contract_money'
                        ,'service_money'
                        ,'discount_type'
                        ,'discount_reason'
                        ,'discount_money'
                        ,'contract_state_title'
                        ,'product_category_title'
                        ,'overseas_study_apply_title'
                        ,'language_train_title'
                        ,'signing_class_name'
                        ,'signing_class_code'
                        ,'signing_curriculum_type'
                        ,'remarks_one'
                        ,'remarks_two'
                        ,'overseas_or_train_title'
                        ,'week_num'
                        ,'remarks_year'

                    ]);
                    // 重点2！！！一般都需要加一个表头，表头的键名顺序需要与最终导出的数据一致
                    data.unshift({ id: "ID", city: "城市", mechanism: '机构名称', department: '部门',
                        part_depart: '分点名称', date_year: '年度', date_month: '月份', date_day: '日期',
                        linesTitle: '条线',country_title: '国家',customer_k3_code: '客户K3码',customer_name: '客户名字',
                        contract_num: '合同号',contract_mould: '合同模板',oa_serial_number: 'OA流水号',customer_grade: '客户年级',
                        business_type: '业务类型',product_type: '产品类型',target_degree: '目标学位',signing_adviser: '签约顾问',
                        apply_year: '入学申请年',apply_month: '入学申请月',signing_money: '签约金额',main_contract_money: '主合同金额',
                        service_money: '服务费收款金额',discount_type: '优惠类型',discount_reason: '优惠原因',discount_money: '优惠金额',
                        contract_state_title: '合同状态',product_category_title: '产品分类',overseas_study_apply_title: '留学申请',language_train_title: '语言培训',
                        signing_class_name: '签约班级名称',signing_class_code: '签约班级编码',signing_curriculum_type: '签约课程类型',remarks_one: '备注一',
                        remarks_two: '备注二',overseas_or_train_title: '留学/培训',week_num: '周数',remarks_year: '财年'});

                    excel.exportExcel(data, '签约统计表.xlsx', 'xlsx');
               }
            });

        });

    });


</script>
</body>
</html>